<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja" dir="ltr">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<script type="text/javascript" src="/pub/js/jquery-1.8.3.min.js"></script>
<script type="text/javascript" src="/pub/js/ph-json2.js"></script>
<script type="text/javascript" src="/pub/js/aes.js"></script>
<script type="text/javascript" src="/pub/js/sha256.js"></script>
<script  type="text/javascript"><!--
##親frameのlocation.href
var OFFLINE_KEY='PaOfflineAuth'
var parentOrigin;
var isOfflineAuth=false;
var isOnlineAuth=false;
var offlinePassHash=null;
var authInfo=null;

##crossDomainRequest情報
var cdr={isIn:false,req:null};
function onRequest(ev){
  if(ev.source!==parent){
    return;
  }
  if(!ev.data){
    return;
  }
  var origin = ev.origin;
  var req=ph.JSON.parse(ev.data);
  if(parentOrigin!=="*" && origin!==parentOrigin){
    return;
  }
  if(cdr.isIn){
    return;//parentからresponseを待たずに続けてrequestされた（異常)
  }
  cdr.isIn=true;
  cdr.req=req;
  if(req.type==="encrypt"){
    if(offlinePassHash){
      req.encryptText=CryptoJS.AES.encrypt(req.plainText, offlinePassHash).toString();
    }else{
      req.encryptText=req.plainText
    }
    response(req);
  }else if(req.type==="decrypt"){
    if(offlinePassHash){
      req.plainText=CryptoJS.AES.decrypt(req.encryptText, offlinePassHash).toString(CryptoJS.enc.Utf8);
    }else{
      req.plainText=req.encryptText
    }
    response(req);
  }else if(req.type==="logout"){
    jQuery.ajax({
      type:'POST',
      url:'ajaxLogout',
      dataType:'json',
      success:function(x){response(x);},
      error:function(x){response({result:false});}
    });
  }else if(req.type==="onlineSetup"){
    jQuery.ajax({
      type:'POST',
      url:'onlineSetup',
      data:{loginId:req.loginId,appSid:req.appSid,token:req.token},
      dataType:'json',
    }).done(onlineSetupDone).fail(onlineSetupFail);
  }else if(req.type==="offlineAuth"){
  }else if(req.type==="info"){
    response(authInfo);
  }
}

function onlineSetupDone(data){
 isOnlineAuth=true;
 offlinePassHash=data.offlinePassHash;
 authInfo=data.authInfo;
 setAuthInfo(data.loginId,data);
 response({result:true});
}

function onlineSetupFail(){
 response({result:false});
}

function getAuthInfo(loginId){
  var offlineInfo={};
  var offlineInfoText=localStorage.getItem(OFFLINE_KEY);
  if(offlineInfoText){
    offlineInfo=ph.JSON.parse(offlineInfoText);
  }
  var authInfo=offlineInfo[loginId];
  if(!authInfo){
    return null;
  }
  authInfo=CryptoJS.AES.decrypt(authInfo, offlinePassHash).toString(CryptoJS.enc.Utf8);
  return authInfo;
}

function setAuthInfo(loginId,authInfo){
  var authInfoText=ph.JSON.stringify(authInfo);
  authInfoText=CryptoJS.AES.encrypt(authInfoText, offlinePassHash).toString();
  var offlineInfo={};
  var offlineInfoText=localStorage.getItem(OFFLINE_KEY);
  if(offlineInfoText){
    offlineInfo=ph.JSON.parse(offlineInfoText);
  }
  offlineInfo[loginId]=authInfoText;
  var offlineInfoText=ph.JSON.stringify(offlineInfo);
  localStorage.setItem(OFFLINE_KEY,offlineInfoText);
}

function response(msg){
  cdr.isIn=false;
  cdr.req=null;
  var jsonMsg=ph.JSON.stringify(msg);
  parent.postMessage(jsonMsg,parentOrigin);
}

jQuery(function(){
  parentOrigin=decodeURIComponent(location.search.substring('?origin='.length));
  if(parentOrigin=='file://'){
    parentOrigin='*';
  }
  if(window.addEventListener){
    window.addEventListener('message',onRequest, false);
  }else if(window.attachEvent){
    window.attachEvent('onmessage',onRequest);
  }
  response({result:true});
});

function offlineLogon(){
  var loginId=jQuery('#loginId').val();
  var password=jQuery('#password').val();
  offlinePassHash=CryptoJS.SHA256(loginId+":"+password");//need solt
  var userInfo=getAuthInfo(loginId);
  if(!userInfo){
    alert('oops1');
    return;
  }
  if(data.offlinePassHash!==offlinePassHash){
    alert('oops2');
    return;
  }
  authInfo=userInfo.authInfo;
  response({result:true});
}

// --></script>
</head>
<body>
<h1>Phantom offline logon</h1>
<div>loginId:<input name=loginId></div>
<div>offline password:<input type='password' name=password></div>
<div><input type='button' value='logon' onclick='offlineLogon();'></div>
</body>
</html>
