<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" /> 
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Pragma" content="no-cache"> 
  <meta http-equiv="Cache-Control" content="no-cache"> 
  <meta http-equiv="Expires" content="0"> 
  <title>PhantomLink pubsub test</title>
  <script type="text/javascript" src="/pub/js/ph.js"></script>
  <script type="text/javascript">
var link;
var sub;

function subscribe(){
  sub=link.subscribe(ph.jQuery("#qname").val(),ph.jQuery("#subname").val());
  ph.jQuery("#subctrl").show();
  sub.onMessage(function(data){
    ph.log('++sub message sub++ message:'+data);
    ph.dump(data);
    ph.log('--sub message sub--');
  });
  sub.onUnload(function(){ph.jQuery("#subctrl").hide();sub=null});
}

function aplUrl(){
  return ph.jQuery("#aplUrl").val();
}

function auth(isOffline){
  if(link!=null){
    link.unlink();
  }
  link=ph.link(aplUrl(),isOffline);
  link.onNotLoading(function(){
    var linkInfo=
    "isOffline:"+link.isOffline + "<br />"
    + "isAuth:"+link.isAuth + "<br />"
    + "isConnect:"+link.isAuth + "<br />"
    + " keyUrl:"+link.keyUrl + "<br />";
    if(link.isAuth){
      var user=link.authInfo.user;
      linkInfo +="loginId:"+ user.loginId + "<br />";
      linkInfo +="nickname:"+ user.nickname + "<br />";
      //linkInfo +="user:"+ ph.JSON.stringify(link.authInfo.user);
    }else{
      linkInfo +="cause:"+ link.cause + "<br />";
    }
    ph.jQuery("#authOutput").html(linkInfo);
    ph.jQuery("#authInfo").show();
    if(link.isConnect){
      ph.jQuery("#pubsub").show();
    }
  });
  link.onUnload(function(){
    ph.jQuery("#authInfo").hide();
    ph.jQuery("#pubsub").hide();
    ph.jQuery("#subctrl").hide();
  });
}

ph.jQuery(function(){
// ドラッグドロップからの入力
  ph.jQuery("#subctrl").bind("drop", function (e) {
    var files = e.originalEvent.dataTransfer.files;
    alert('publish file:'+files[0].name);
    var data={data:files,source:'drop'};
    try{
      sub.publish(data);
    }catch(e){
    ph.log(e);
    }
    return false;
  })
  .bind("dragenter", function () {
    // false を返してデフォルトの処理を実行しないようにする
    return false;
  })
  .bind("dragover", function () {
    // false を返してデフォルトの処理を実行しないようにする
    return false;
  });
  ph.jQuery("#authInfo").hide();
  ph.jQuery("#pubsub").hide();
  ph.jQuery("#subctrl").hide();
  ph.debug=true;
});

  </script>
</head>
<body>
<H1>PhantomLink pubsub test</H1>
<a href='/admin' target='adminWnd'>admin</a>|
<a href='' target='_blank'>pubsubTest</a>|
<a href='storageTest.html' target='_blank'>storageTest</a>|
<a href='javascript:location.reload()'>reload</a>
<br />
<hr/>
aplUrl:<input id='aplUrl' type="text" value="/link1" style="width:256px;"/>
<input type="button" value="online link" onclick="auth(false);"/>
<br />
<div id="authInfo">
<hr/>
AuthInfo:<br />
<div id="authOutput"></div>
</div>
<div id="pubsub">
<hr/>
<input type="button" value="profile" onclick="link.userProfile();"/>
<input type="button" value="logout" onclick="link.logout();"/>
<input type="button" value="unlink" onclick="link.unlink();"/><br />
qname:<input id='qname' type="text" value="qname" style="width:100px;"/>
subname:<input id='subname' type="text" value="subname" style="width:100px;"/>
<input type="button" value="sbscribe" onclick="subscribe();"/><br />
<input type='text' id='directPublishData' value='directPublishData'/>
<input type="button" value="direct publish" 
  onclick="link.publish(ph.jQuery('#qname').val(),{data:ph.jQuery('#directPublishData').val(),source:'directPublish'});"/>
<div id="subctrl">
<hr/>
<input type='text' id='publishData' value='publishData'/>
<input type="button" value="publish string" 
  onclick="sub.publish(ph.jQuery('#publishData').val());"/>
<input type="button" value="publish object" 
  onclick="sub.publish({data:ph.jQuery('#publishData').val(),source:'objectPublish'});"/>
<input type="button" value="publish bin" 
  onclick="sub.publish({data:ph.stringToArrayBuffer(ph.jQuery('#publishData').val()),source:'binaryPublish'});"/>
<form id='publishFormTest'>
<input type='file' name='data' />
<input type='hidden' name='source' value='formPublish'/>
<input type="button" value="publishForm" 
  onclick="sub.publishForm('publishFormTest');"/>
</form>
<p>ここにファイルをドロップするとpublishします</p>
<input type="button" value="unsubscribe" onclick="sub.unsubscribe();"/>
</div>
</div>
</div>
<Hr/>
<div id="debug">
<input type="button" value="出力クリア" onclick="ph.jQuery('#phDebugArea').text('');"/>
<pre id="phDebugArea"></pre>
</div>
</body>
</html>
